<!DOCTYPE html>
<html lang="en">
  <title>Daniel Nechtan</title>
  <meta charset="utf-8" />
   <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="og:type" content="summary_large_image" />
  <meta name="og:image" content="https://nechtan.io/daniel.jpg" />
  <meta name="og:title" content="nechtan.io" />
  <meta name="og:description" content="Daniel Nechtan / System Administration" />
  <meta name="description" content="Daniel Nechtan / System Administration" />
  <link rel="stylesheet" href="style.css" />

  <body class="mw7 w-100 center pa3">
  <div id="headatar">
    <a href="/" title="Daniel Nechtan">
      <img src="/daniel.jpg" alt="Daniel Nechtan" class="avatar w4"/>
    </a>
    <div id="headtit">
      <h4 class="">Daniel Nechtan</h4>
      <span><a href="mailto:daniel@nechtan.io">daniel@nechtan.io</a></span>
      | <span><a href="https://wa.me/447462815195">WhatsApp</a></span>
      | <span><a href="https://signal.me/#p/+447462815195">Signal</a></span>
    </div>
  </div>
  <p></p>
  <p>
    <a href="#Projects">Projects</a> &mdash;
    <a href="#Articles">Articles</a> &mdash;
    <a href="https://github.com/DanielNechtan">Github</a> &mdash;
    <a href="https://twitter.com/DanielNechtan">Twitter</a> &mdash;
    <a href="/CV.html">CV</a> &mdash;
    <a href="/contact.html">Contact</a>
  </p>
  <hr/>
<h2 id="OpenBSD%207.2%20Minimalist%20Desktop">OpenBSD 7.2 Minimalist Desktop</h2>

<p>It has been a few years since I last wrote about OpenBSD on the desktop (or laptop), and support for modern hardware has continued to improve.  In fact, I even run OpenBSD on an Apple Macbook Pro M1&#47;Silicon now!</p>

<p>I was going to update the previous article but as my own habits have changed quite a lot and are more in line with the spirit of the OpenBSD base it seemed like a new article was warranted. I may update this article in the future with &#8216;rice&#8217; for cwm(1) (including Xresources, etc) but at present this is a basic guide to getting a generic desktop system up and running. </p>

<p>It is customary when mentioning any command, file, or topic that has a manual page to include which manual it&#8217;s included in.  So when you see <code>cwm(1)</code> - I am referring to cwm in the General Commands manual, which is manual 1.  To read that manual page, type: man 1 cwm (though <code>man cwm</code> will default to cwm(1)).</p>

<p>Hardware: Lenovo Thinkpad X280 (8GB RAM &#47; 256GB NVMe &#47; Intel Wifi)</p>

<p><a href="newdesktop.png"><img src="newdesktop.png" alt="OpenBSD+cwm+xterm+tmux" /></a></p>

<p>Grab install72.img from https:&#47;&#47;cdn.openbsd.org&#47;pub&#47;OpenBSD&#47;7.2&#47; and write it to a USB dongle. On a Unix-like operating system dd can be used to accomplish this:</p>

<pre><code>dd if=install72.img of=&#47;dev&#47;sdb bs=1M conv=fsync
</code></pre>

<p>When installing OpenBSD I always use softraid(8) CRYPTO to encrypt my system.  Instructions to do this are in the <a href="https://openbsd.org/faq/faq14.html#softraidFDE">OpenBSD FAQ</a>.</p>

<p>The default disklabel(8) layout is recommended for most situations, however, if you will be compiling a lot of ports you may want to edit the default layout to make more space in &#47;usr&#47;src and &#47;usr&#47;obj; here is what I ended up with:</p>

<pre><code>OpenBSD area: 1024-500116574; size: 238.5G; free: 0.0G
#                size           offset  fstype [fsize bsize   cpg]
  a:             1.0G             1024  4.2BSD   2048 16384 12960 # &#47;
  b:             8.1G          2098176    swap                    # none
  c:           238.5G                0  unused                    
  d:            16.0G         19086080  4.2BSD   2048 16384 12960 # &#47;tmp
  e:            20.0G         52644992  4.2BSD   2048 16384 12960 # &#47;var
  f:            10.0G         94590720  4.2BSD   2048 16384 12960 # &#47;usr
  g:             4.0G        115571584  4.2BSD   2048 16384 12960 # &#47;usr&#47;X11R6
  h:            30.0G        123973600  4.2BSD   2048 16384 12960 # &#47;usr&#47;local
  i:             0.0G               64   MSDOS                    
  j:            12.0G        186900192  4.2BSD   2048 16384 12960 # &#47;usr&#47;src
  k:            16.0G        212074048  4.2BSD   2048 16384 12960 # &#47;usr&#47;obj
  l:           121.3G        245633824  4.2BSD   2048 16384 12960 # &#47;home
</code></pre>

<h3 id="Firmware%20and%20networking">Firmware and networking</h3>

<p>OpenBSD detects the iwm(8) 802.11x wireless device but will need the firmware for it to be functional. If you have a supported USB sup
ported adapter or Lenovo&#8217;s adapter cable for the built-in em(8) ethernet device you can skip the following step as OpenBSD will run fw
_update(8) if you configure your ethernet adapter correctly.</p>

<p>On another computer with network access, format a USB disk as FAT and copy everything from http:&#47;&#47;firmware.openbsd.org&#47;firmware&#47;7.2&#47; onto it. I find the easiest way to grab these files on a non-OpenBSD system is to install and use lftp:</p>

<pre><code>$ lftp http:&#47;&#47;firmware.openbsd.org&#47;firmware&#47;7.2&#47;
cd ok, cwd=&#47;firmware&#47;7.2
lftp firmware.openbsd.org:&#47;firmware&#47;7.2&#62; mget * 
</code></pre>

<p>Unmount the disk and keep it for later.</p>

<h3 id="First%20boot">First boot</h3>

<h4 id="Firmware">Firmware</h4>

<p>Insert your USB key with the firmware, mount it, copy the firmware over and install it:</p>

<pre><code># dmesg | grep sd
# mount_msdos &#47;dev&#47;sd3i &#47;mnt
# mkdir &#47;home&#47;firmware
# cp &#47;mnt&#47;firmware&#47;* &#47;home&#47;firmware&#47;
# mv &#47;home&#47;firmware&#47;SHA256.SIG &#47;home&#47;firmware&#47;SHA256.sig
# fw_update -p &#47;home&#47;firmware&#47;
</code></pre>

<h4 id="Connecting%20to%20Wifi">Connecting to Wifi</h4>

<p>If you skipped setting up wifi during installation, you can do so now by editing hostname.if(5), where <code>if</code> is your wifi interface. Running ifconfig(8) can help you identify the interface. For Intel 7000-9000 based cards such as on this Thinkpad, the device is iwm0.</p>

<p>&#47;etc&#47;hostname.iwm0:</p>

<pre><code>join somewifinet wpakey mywpapassphrase
inet autoconf
</code></pre>

<p>That&#8217;s it. When you next reboot it will connect automatically.  If you ever need to manually reset your network interfaces and bring them back up, see netstart(8). For example:</p>

<pre><code>sh &#47;etc&#47;netstart iwm0
</code></pre>

<h4 id="Disk%20performance">Disk performance</h4>

<p>It is recommended to disable the updating of atime (access time) on filesystems with heavy usage such as laptops or NNTP servers where disk performance is more important than maintaining accurate file access times. </p>

<p>For user data (&#47;home), we can increase performance by using the softdep (soft dependencies) mount option which prevents filesystem metadata from being written immediately. This isn&#8217;t recommended for critical filesystem mountpoints where it can cause problems but for user data it is generally safe.</p>

<p>See mount(8).</p>

<pre><code># fstab=${mktemp}
# cp &#47;etc&#47;fstab "$fstab" &#38;&#38;
   cat $fstab | awk &#39;&#47;rw&#47; {sub(&#47;rw&#47;,"rw,noatime")}1&#39;
   | awk &#39;&#47;home&#47; {sub(&#47;noatime&#47;,"noatime,softdep")}1&#39; &#62; &#47;etc&#47;fstab
</code></pre>

<h4 id="Xenocara%20&amp;#47;%20xenodm(1)">Xenocara &#47; xenodm(1)</h4>

<p>Xenocara is OpenBSD&#8217;s infrastructure for the X(7).org Server and window managers included in base - cwm(1) and fvwm(1).</p>

<p>xenodm(1) is the X(1) Display Manager which manages access to the Xserver(1), providing a graphical login interface.</p>

<p>By default, xconsole(1) is started by xenodm(1) and the background set to the familiar (and perhaps ugly) root weave pattern.  We can easily remove these in &#47;etc&#47;X11&#47;xenodm&#47;Xsetup_0, have the background set to a solid dark grey colour and disable the system bell:</p>

<pre><code># sed -i &#39;&#47;${exec&#47;s&#47;^&#47;#&#47;g&#39; &#47;etc&#47;X11&#47;xenodm&#47;Xsetup_0
# PREF="\${exec_prefix}&#47;bin" &#38;&#38;
    echo "$PREF&#47;xsetroot -solid dimgrey\n$PREF&#47;xset b off\n" &#62;&#62; &#47;etc&#47;X11&#47;xenodm&#47;Xsetup_0
</code></pre>

<h4 id="Add%20your%20user%20to%20staff%20and%20doas.conf(5)">Add your user to staff and doas.conf(5)</h4>

<p>It&#8217;s not recommended to normally login as the root user. For a long time, Unix-like operating systems relied on <code>sudo</code> to perform operations as another user (such as root); in 2015 Ted Unangst developed doas(1) for OpenBSD as a safer and simpler replacement.</p>

<p>Let&#8217;s allow any user in the wheel group(5) to execute commands as root with doas(1):</p>

<pre><code># echo "permit :wheel" &#62;&#62; &#47;etc&#47;doas.conf
</code></pre>

<p>In addition to groups such as wheel, OpenBSD (like other BSD operating systems) maintains a login class capability database that is configured in login.conf(5).  This allows fine-tuning of resources for users and processes in a robust yet simple way. On a desktop or laptop, the user we created is probably going to be our only human user so we should add it to the staff class and increase resources to ensure we can use the system as a daily driver:</p>

<pre><code># usermod -L staff myuser
# usermod -G staff myuser
</code></pre>

<p>In `&#47;etc&#47;login.conf&#8217; update the staff class as follows using vi(1):</p>

<pre><code>staff:\
    :datasize-cur=4096M:\
    :datasize-max=infinity:\
    :maxproc-max=512:\
    :maxproc-cur=256:\
    :openfiles-cur=4096:\
    :openfiles-max=4096:\
:ignorenologin:\
:requirehome@:\
:tc=default:
</code></pre>

<p>You should increase datasize-cur depending on your total memory. 4096M works relatively well for 8GB though I have noticed with excessive web browser use that things can freeze up.  Likewise, openfiles-cur&#47;max should be increased depending on your needs.  If you run Syncthing or work with large Bittorrent files for example you will probably want to increase that to an insane amount and replicate it in &#47;etc&#47;sysctl.conf(5): kern.maxfiles.</p>

<p>Rebuild the database:</p>

<pre><code>[ -f &#47;etc&#47;login.conf.db ] &#38;&#38; cap_mkdb &#47;etc&#47;login.conf
</code></pre>

<h4 id="Kernel%20settings">Kernel settings</h4>

<p>Here are some recommended values (based on this system) for a desktop to add to &#47;etc&#47;sysctl.conf(5):</p>

<pre><code>cat &#60;&#60;EOF &#62; &#47;etc&#47;sysctl.conf
# Shared memory
kern.shminfo.shmall=3145728
kern.shminfo.shmmax=2147483647
kern.shminfo.shmmni=1024
kern.shminfo.shmseg=1024

# Semaphores
kern.seminfo.semmns=4096
kern.seminfo.semmni=1024

kern.maxproc=32768
kern.maxthread=4096
kern.maxfiles=65535
kern.bufcachepercent=90
kern.maxvnodes=262144
kern.somaxconn=2048
EOF
</code></pre>

<h4 id="X%20Session">X Session</h4>

<p>To enable tap-to-click on the trackpad:</p>

<pre><code># echo "mouse.tp.tapping=1" &#62;&#62; &#47;etc&#47;wsconsctl.conf
</code></pre>

<p>Now exit then login as your regular user and create <code>.xsession</code> in your home directory with the following:</p>

<pre><code>export LANG=en_US.UTF-8            # or your locale(1)
export ENV=$HOME&#47;.kshrc            # korn shell
ulimit -Sc 0            # No core dumps!
xrdb -merge $HOME&#47;.Xresources   # load UI customisations 
setroot -solid dimgrey      # set background colour
xset b off              # disable bell
setxkbmap -option ctrl:nocaps   # Use capslock as CTRL  
xterm &#38;             # Run xterm
xrandr --dpi 96         # Fix scaling of some X&#47;QT programs
xidle -delay 5 -sw -timeout 300 -program "&#47;usr&#47;X11R6&#47;bin&#47;xlock -mode qix" &#38;
exec cwm                # Run our window manager
</code></pre>

<p>At this point we should <code>reboot(8)</code> - then we can benefit from our disk performance tweaks which you will be thankful for when installing packages.</p>

<h3 id="Second%20boot%20###">Second boot ###</h3>

<p>If you didn&#8217;t make any typos, you should be greeted by xenodm(1) again and able to login as your normal staff user before being presented with a terminal.</p>

<h4 id="Customisation">Customisation</h4>

<p>Let&#8217;s install some packages, adjusting to your own taste:</p>

<pre><code>$ doas pkg_add ImageMagick \
        bzip2 \
    git \
    gnupg \
    firefox \
    iridium \
    w3m \
    mpv \
    inconsolata-font \
    spleen \
    ffmpeg \
    unzip \
    keepassxc \
    weechat \
    picom \ 
    mupdf \
    newsboat \
    neomutt \
    vim \
</code></pre>

<p>If you would prefer a more familiar desktop environment, xfce can be installed:</p>

<pre><code>$ doas pkg_add xfce xfce-extras xfce4-power-manager upower xscreensaver
</code></pre>

<p>Then in .xsession, replace <code>exec cwm</code> with <code>exec startxfce4</code> and remove the xidle and xterm lines. </p>

<h4 id="Xresources">Xresources</h4>

<p>You could write a book, or at least a pamphlet, on styling X(7).  Callum Smith has some more complete configs, but the following ~&#47;.Xresources file will at least get you started with a less-ugly xterm to use in cwm(1):</p>

<pre><code>*visualBell: True 
xterm.loginShell: true 
xterm*faceName: Inconsolata:size=16
xterm*dynamicColors: true
xterm*utf8: 2
xterm*eightBitInput: true
xterm*scrollBar: false
xterm*foreground: rgb:a8&#47;a8&#47;a8
xterm*background: rgb:00&#47;00&#47;00
</code></pre>

<p>If you have performance issues in Firefox, in the navigation bar type: about:config <enter> then search for an enable this option:</p>

<pre><code>layers.acceleration.force-enable=true
</code></pre>
<hr/>
<hr/>
<p><a href="/">${HOME}</a></p>
<div class="footer">
<p>&copy; 1996&ndash;2022 <a href="/">Daniel Nechtan</a> | No cookies or JavaScript | <a href="https://rgz.ee/ssg.html">ssg</a></p>
</div>
</body>
</html>
